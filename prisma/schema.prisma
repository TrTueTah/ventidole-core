generator client {
  provider = "prisma-client"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
  output   = "../src/db/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String            @id @default(cuid())
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  version         Int               @default(0)
  email           String            @unique(map: "user_email_unique_partial") @db.VarChar(255)
  password        String            @db.VarChar(255)
  role            Role
  deviceToken     String?           @db.VarChar(255)
  isDeleted       Boolean           @default(false) @map("is_deleted")
  isOnline        Boolean           @default(false) @map("is_online")
  social_accounts SocialAccount[]
  verifications   Verification[]
  fan             Fan?
  idol            Idol?
  chatParticipants ChatParticipant[]

  @@map("user")
}

model Verification {
  id          String           @id @default(cuid())
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  version     Int              @default(0)
  type        VerificationType
  token       String           @unique
  expiresAt   DateTime         @map("expires_at")
  userId      String?          @map("userId")
  usedAt      DateTime?        @map("used_at")
  confirmedAt DateTime?        @map("confirmed_at")
  email       String?          @db.VarChar(255)
  user        User?            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("verifications")
}

model SocialAccount {
  id         String                @id @default(cuid())
  isActive   Boolean               @default(true)
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt
  version    Int                   @default(0)
  provider   SocialAccountProvider
  providerId String                @map("provider_id")
  userId     String                @map("userId")
  user       User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@map("social_accounts")
}

model Fan {
  id              String            @id @default(cuid())
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  version         Int               @default(0)
  username        String            @unique @db.VarChar(100)
  avatarUrl       String?           @map("avatar_url") @db.VarChar(255)
  backgroundUrl   String?           @map("background_url") @db.VarChar(255)
  bio             String?           @db.VarChar(500)
  userId          String            @map("userId") @unique
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  followedGroups  FanFollowGroup[]

  @@map("fans")
}

model Idol {
  id              String        @id @default(cuid())
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  version         Int           @default(0)
  stageName       String        @map("stageName") @db.VarChar(100)
  bio             String?       @db.VarChar(500)
  avatarUrl       String?       @map("avatar_url") @db.VarChar(255)
  backgroundUrl   String?       @map("background_url") @db.VarChar(255)
  userId          String        @map("userId") @unique
  groupId         String        @map("groupId")
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  group           Group         @relation(fields: [groupId], references: [id], onDelete: Cascade)
  chatChannels    ChatChannel[]

  @@map("idols")
}

model Group {
  id              String            @id @default(cuid())
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  version         Int               @default(0)
  description     String?           @db.VarChar(500)
  logoUrl         String?           @map("logoUrl") @db.VarChar(255)
  backgroundUrl   String?           @map("backgroundUrl") @db.VarChar(255)
  groupName       String            @map("groupName") @db.VarChar(100)
  idols           Idol[]
  followers       FanFollowGroup[]
  chatChannels    ChatChannel[]

  @@map("groups")
}

model FanFollowGroup {
  id        String   @id @default(cuid())
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version   Int      @default(0)
  fanId     String   @map("fanId")
  groupId   String   @map("groupId")
  fan       Fan      @relation(fields: [fanId], references: [id], onDelete: Cascade)
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([fanId, groupId])
  @@index([fanId])
  @@index([groupId])
  @@map("fan_follow_group")
}

model ChatChannel {
  id              String              @id @default(cuid())
  isActive        Boolean             @default(true)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  version         Int                 @default(0)
  name            String?             @db.VarChar(255)
  description     String?             @db.VarChar(500)
  type            ChatChannelType
  groupId         String?             @map("groupId")
  idolId          String?             @map("idolId")
  isAnnouncement  Boolean             @default(false) @map("is_announcement")
  lastMessageAt   DateTime?           @map("last_message_at")
  firebaseDocId   String              @unique @map("firebase_doc_id") @db.VarChar(255)
  group           Group?              @relation(fields: [groupId], references: [id], onDelete: Cascade)
  idol            Idol?               @relation(fields: [idolId], references: [id], onDelete: Cascade)
  participants    ChatParticipant[]

  @@index([groupId])
  @@index([idolId])
  @@index([type])
  @@index([lastMessageAt])
  @@map("chat_channels")
}

model ChatParticipant {
  id              String      @id @default(cuid())
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  version         Int         @default(0)
  channelId       String      @map("channelId")
  userId          String      @map("userId")
  role            ChatRole    @default(MEMBER)
  lastReadAt      DateTime?   @map("last_read_at")
  unreadCount     Int         @default(0) @map("unread_count")
  isMuted         Boolean     @default(false) @map("is_muted")
  channel         ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([channelId, userId])
  @@index([userId])
  @@index([channelId])
  @@map("chat_participants")
}

enum Role {
  FAN
  ADMIN
  IDOL
}

enum VerificationType {
  FIND_EMAIL
  RESET_PASSWORD
  REGISTER_ACCOUNT
  UPDATE_PROFILE
}

enum SocialAccountProvider {
  GOOGLE
  FACEBOOK
}

enum ChatChannelType {
  DIRECT
  GROUP
  ANNOUNCEMENT
}

enum ChatRole {
  ADMIN
  MEMBER
}